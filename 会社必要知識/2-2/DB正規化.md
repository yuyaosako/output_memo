# DB正規化

## 概要
- 目的
    - データベースで保持するデータの冗長性を排除し、一貫性と効率性を確保するためのデータ形式へ変換すること。
- メリット
    - データの重複を排除し、矛盾が発生しないテーブル設計ができる。
    - データを一元管理し、データの整合性を保ちやすくなります。
- デメリット
    - 正規化によりテーブルの数が増える事で、結合操作がより必要になり、検索SQLのパフォーマンスが劣化する。
- 結論
    - ベースは正規化を行い、他の手法によってパフォーマンス向上が見込めない場合に非正規化を検討する。

## 前提データ
| 会社コード | 会社名 | 社員番号 | 社員名 | 年齢 | 部署コード | 部署名 |
| :---: | :---: | :---: | :---: | :---: | :---: | :---: |
| 001 | コムコシステム | 0001<br>0002 | コムコ太郎<br>コムコ次郎 | 30<br>40 | 101<br>102 | SI事業部<br>営業部 |
| 002 | 田中商事 | 0001<br>0002 | 田中太郎<br>田中次郎 | 25<br>50 | 103<br>102 | 総務部<br>営業部 |

## 第一正規化(定義：1つのセルには1つの値しか含まれないこと)
- 前提データのような1つのセルに複数の値を入れることはできない。
- 1つのセルに1つの値が含まれている時、その値を「スカラ値」という。
- 前提テーブルを第一正規化すると以下の通りとなる。
    | 会社コード | 会社名 | 社員番号 | 社員名 | 年齢 | 部署コード | 部署名 |
    | :---: | :---: | :---: | :---: | :---: | :---: | :---: |
    | 001 | コムコシステム | 0001 | コムコ太郎 | 30 | 101 | SI事業部 |
    | 001 | コムコシステム | 0002 | コムコ次郎 | 40 | 102 | 営業部 |
    | 002 | 田中商事 | 0001 | 田中太郎 | 25 | 103 | 総務部 |
    | 002 | 田中商事 | 0002 | 田中次郎 | 50 | 102 | 営業部 |
- 問題点
    - 社員を登録しない会社は作成できない。
    - 会社名や部署名が変更になると、複数レコードを変更しなければならず、データ不整合が起き得る。


## 第二正規化(定義：部分関数従属を排除し、完全関数従属にすること)
- 関係従属性
    - 特定のカラムAの値が決まれば、別のカラムBの値も決まるような関係。<br>この場合、カラムBはカラムAに関係従属していると呼ぶ。
    - 例）社員証の社員番号を確認すれば、その持ち主の社員名を特定することが出来る。　など

- 部分関係従属性
    - ある非キー属性(主キーやユニークキーに含まれないカラム)が、候補キーの(主キーやユニークキーなど)ー部に関数従属しているような関係。
    - データベース設計の際は、目的の行（データ）を識別するための項目である主キーを決める。<br>主キーが複数あるテーブルにおいて、そのうちの一部のキーだけで決定できる項目がある場合が部分関数従属となる。
    - 例）上記テーブルでは以下の通りに会社名は会社コードに部分関係従属している。

- 完全関数従属性
    - 主キーを構成する全ての列に従属性がある関係性。

- 第一正規形のテーブルを第二正規化すると以下の通りとなる。
    - 主キーは「会社コード」と「社員番号」
        - そのため、社員番号が被っていても会社コードが異なればOK。
    - 「会社名」だけは「会社コード」のみに従属している。
    - 会社マスタ
        | 会社コード | 会社名 |
        | :---: | :---: |
        | 001 | コムコシステム |
        | 002 | 田中商事 |

    - 社員テーブル
        | 会社コード | 社員番号 | 社員名 | 年齢 | 部署コード | 部署名 |
        | :---: | :---: | :---: | :---: | :---: | :---: |
        | 001 | 0001 | コムコ太郎 | 30 | 101 | SI事業部 |
        | 001 | 0002 | コムコ次郎 | 40 | 102 | 営業部 |
        | 002 | 0001 | 田中太郎 | 25 | 103 | 総務部 |
        | 002 | 0002 | 田中次郎 | 50 | 102 | 営業部 |
- 問題点：
    - 社員が存在しない部署名はDB上に登録できない。


## 第三正規化(定義：推移的関数従属している列を切り出した状態にすること)
- 推移関数従属性
    - あるテーブルの非キー属性Aが特定の非キー属性Bに関数従属していること。
    - 例）{会社コード、社員ID} → {部署コード}と、{部署コード} → {部署}の従属関係がある。<br>　　つまり、{会社コード、社員ID} → {部署コード} → {部署}と言える。

- 第二正規形のテーブルを第二正規化すると以下の通りとなる。
    - 会社マスタ
        | 会社コード | 会社名 |
        | :---: | :---: |
        | 001 | コムコシステム |
        | 002 | 田中商事 |

    - 部署マスタ
        | 部署コード | 部署名 |
        | :---: | :---: |
        | 101 | SI事業部 |
        | 102 | 営業部 |
        | 103 | 総務部 |
        | 104 | 広報部 |

    - 社員テーブル
        | 会社コード | 社員番号 | 社員名 | 年齢 | 部署コード |
        | :---: | :---: | :---: | :---: | :---: |
        | 001 | 0001 | コムコ太郎 | 30 | 101 |
        | 001 | 0002 | コムコ次郎 | 40 | 102 |
        | 002 | 0001 | 田中太郎 | 25 | 103 |
        | 002 | 0002 | 田中次郎 | 50 | 102 |