# コンテナ・Docker周りの整理
## 【コンテナの基礎】
- 従来の課題
    - OSやライブラリ、FW、他アプリケーションやDBなどが環境ごとによって異なる。
        - この環境差異が原因で他の環境では動くが、本番では動かない等の事象が発生することが課題だった。
- コンテナの利点
    - コンテナ技術により、アプリケーションの実行基盤はコンテナを動かせばよいだけとなり、環境差異が生まれなくなった。
        - 開発環境と本番環境、各自のローカル環境など。
    - 各種モジュールやライブラリなどを各自が個々でダウンロードする必要がない。
- コンテナイメージ：OS + アプリケーション環境を1つのパッケージイメージとしてまとめたもの。
- コンテナ：コンテナイメージを展開したもの。

- コンテナアプリケーション開発のライフサイクル
    1. Build：OSとアプリケーション環境を1つのコンテナイメージにすること。
        - Dockerfileを記述し、イメージを作成する工程。
        - 従来であれば実行環境がコンパイルして実行ファイルを作成する工程。
    2. Ship：コンテナイメージを移動、共有すること。
        - Push：完成したコンテナイメージをイメージレジストリ(Docker Hubなど)に格納する。
        - Pull：コンテナプラットフォームから取り込む。
    3. Run：コンテナイメージを展開して稼働させること。

## 【Dockerコマンド(抜粋)】
- `docker image build`
    - Dockerfileに記述した内容を上から順番に処理していく。
    - リポジトリ名を付けないとpushできない。
        -t コンテナイメージ名 Dockerfileパス
- `docker container ls オプション`
    - build or pullしたコンテナイメージの確認
    - -a : Exitedも含めたすべてのイメージを確認できる
- `docker container run`
    - イメージを元にコンテナを起動する。
    - Dockerfileで定義されたCMDやENTRYPOINT命令でアプリケーションが実行されている状態。
    - --name : 起動するコンテナに名前を付ける
    - -d : バックグラウンドで起動する
    - -p : ポート指定(ホストポート : コンテナポート)
        - 8080 : 80の場合、ホストの8080ポートにアクセスするとコンテナ上で動作している80番ポートにアクセスできる。
- `docker container exec -it コンテナ名 or ID`
    - 稼働しているコンテナに接続する。
    - -it : 標準出力を開いたままにできるため、対話的な入力が可能。デフォルトで設定してよい。
- `docker container stop`
    - 稼働しているコンテナを停止する
- `docker container start`
    - 停止したコンテナを起動する。
- `docker container restart`
    - コンテナを再起動する
    - runはコンテナ作成から起動、startは作成済みコンテナの起動、restartは起動中コンテナの再起動。
- `docker container cp コンテナホストのコピー元パス コンテナ名orID：コンテナ内のコピー先パス`
    - 稼働中にコンテナでホストとファイルのやり取りをする。
    - コンテナ同士の場合は別コマンドを利用する。
- `docker container rm`
    - コンテナを停止して削除する
- `docker history イメージ名`
    - イメージを生成する時のコマンド実行を確認する。

## 【Dockerfile】
- FROM(必須項目)
    - ベースイメージの設定
    - タグ名を省略したときはベースイメージのlatestが適用される。

- RUN(最も使う)
    - イメージを作成するために実行するコマンドを記述する
        - 例：ライブラリのインストール、ミドルウェアの設定、環境構築のためのコマンド実行　など
    - ①Shell形式での記述
        - コンテナ内で/bin/sh -c を使ってコマンド実行した時と同じ挙動。
        - `RUN apt-get install -y nginx`  など
    - ②Exec形式での記述
        - `RUN ["/bin/bash", "-c", "apt-get install -y nginx"]`  など
        - 引数で文字列を指定するときはシングルクォーテを使う。
            - `RUN ["/bin/bash", "-c", "echo 'Hello World' "]`  など
        - コマンド引数に$PYTHONのような環境変数の指定はできない。
- CMD
    - コンテナ内でコマンドを実行する際に用いる。
    - Dockerfile内に1つのCMD命令のみ記述可能。複数ある場合は最後の記述が適用される。
    - RUNと同様Shell形式とExec形式での書き方がある。
    - docker container run実行時に引数で新たなコマンドを指定した場合、優先して実行される。
- ENTRYPOINT
    - コンテナ内でコマンドを実行する際に用いる。
    - 上記同様Shell形式とExec形式での書き方がある。
    - 指定したコマンドは必ずコンテナで実行される。
        - 実行時にコマンド引数を指定したい場合は、上記のCMDと併せて以下の形とする。
            - ENTRYPOINT：実行したいコマンド
            - CMD：コマンドの引数
- ONBUILD
    - 次のビルドで実行するコマンドを設定する。
    - 例 インフラ環境構築に関する部分をベースイメージとして作成し、プログラムデプロイ回りをONBUILDにする。
- ENV
    - Dockerfile内で使用する環境変数を設定する。
    - ENV key名 value：複数の環境変数を設定したい場合は複数命令必要となり、その分だけDockerイメージが作られる。
    - Env key=value：一度に複数の値をセットできるため、イメージは1つのみ。
- WORKDIR
    - 命令を実行するための作業用ディレクトリを指定する。
    - 複数回利用でき、相対パスで指定した場合は前のWORKDIRで設定した相対パスとなる。
        - WORKDIR /first<br>
        WORKDIR second<br>
        RUN ["pwd"] ⇒ /first/second
    - ENVを用いて環境変数に設定したディレクトリの値も利用できる。
        - ENV DIRPATH /first<br>
        ENV DIRNAME second<br>
        WORKDIR $DIRPATH / $DIRNAME<br>
        RUN ["pwd"] ⇒ /first/second
- USER
    - イメージ実行やRUN, CMD, ENTRYPOINT命令などを実行するユーザーを指定する場合に使用する。
    - ※予めRUN命令でadduserしておく必要がある。
- EXPOSE
    - コンテナの公開するポート番号を指定する。
- ARG
    - Dockerfile内でのみ使用する変数を定義する。
    - ※ENVは環境変数となるため、アプリケーション内でも使用できる。
- COPY
    - localにあるファイルやディレクトリを配置する場合に使用。
    - COPY <配置元>・・・ <配置先>
- ADD
    - リモートファイルやtarファイル(アーカイブファイル)を配置する場合に使用。
- VOLUME
    - 指定した名前のマウントポイントを作成し、ホストやその他のコンテナから外部マウントを行う。
    - ※永続データはホストマシン上のボリュームにマウントする or 共有ストレージをボリュームとしてマウントする。

## 【Docker Compose】
- docker-compose.ymlファイルを作成することで複数のコンテナを一括管理できる。
- 但し、シングルホストでの利用が前提となる。
- docker-compose.ymlの記述
    - version
        - バージョンによって記述できる項目が異なる。
        - 複数の定義ファイルを使用する場合は、全てを同じバージョンとする。
    - image
        - コンテナの元となるベースイメージの指定。
        - イメージの名前 or イメージのIDを指定する。
        - タグを指定しない場合、最新版がダウンロードされるため本番環境用などはバージョンを指定するべき。
    -build
        - Dockerfileを自動ビルドしてベースイメージに指定する際に使用する。
        - docker-comose.ymlのあるディレクトリをカレントディレクトリとして、Dockerfileの場所を指定する。
        - args: に記述をすることで、ビルド時に使用する引数を設定できる。
    - command, entrypoint
        - コンテナで動かすコマンドを上書きできる。
    - ports
        - 「"ホストマシンのポート番号": "コンテナのポート番号"」 or 「"コンテナのポート番号"」で記述する。後者の場合、ホストマシンのポート番号はランダム。
    - depends_on
        - サービスの依存関係を定義する。
        - 依存関係を持たせたいサービスに依存先のサービス名を記述する。
    - environment, env_file
        - environmentはコンテナ内の環境変数をyamlファイル内で指定する際に使用する。
        - env_fileは環境変数を定義した別ファイルを読み込む際に使用する。
            - 複数指定可能。
            - 相対パス、絶対パスどちらでも指定可能。
    - container_name
        - コンテナに名前を付ける時に使用する。
    - volumes, volumes_from
        - volumesは「ホストのディレクトリパス：コンテナのディレクトリパス」でマウント先を指定する。
        - volumes_fromは別のコンテナから全てのボリュームをマウントする際に使用する。
## 【コンテナオーケストレーション】
- 本来コンテナは複数のコンテナホスト上で複数のコンテナを連携して利用するが、その管理の煩雑さを解消するために使用するツール。

## 【その他】
- マウント
    - コンテナホストにあるデータをコンテナ内でも利する仕組み。
    - ホスト側にデータ領域を確保するのは、コンテナの破損でデータが破棄されないように。
    - バインドマウント
        - コンテナ外部にあるファイルをコンテナ側から読み書きできる。
    - ボリューム
        - Dockerが管理するデータ領域のみマウント可能
    - データボリュームコンテナ
        - ボリューム提供用コンテナを1つ作り、複数のコンテナで共有する仕組み。
        - コンテナ作成時に--volumes-fromで提供コンテナを指定する。

- コンポーネント
    - Docker Engine(Dockerのコア機能)
    - Docker Registry(イメージ公開・共有)
    - Docker Compose(複数コンテナ一元管理)
    - Docker Machine(Docker実行環境構築)
    - Docker Swarm(クラスタ管理)

- コンテナイメージの軽量化
    - DockerfileのFrom命令のみで参照可能なscratchなどの軽量なベースイメージの利用
    - コマンドの連結(1行ずつ実行されるため、実行行は少ない方が良い。)
        - RUN ○○ && ●●　など<br>
        ※最初は1行ずつ書いてトライ＆エラーをした後、まとめる。

## 課題
- 仮想マシンとの違いは？
- ハイパーバイザーとは？
- カーネルとは？
- マルチステージビルドについて
- CI/CDについて
- VscodeのdevContainerについて
- 別ポートへの接続
-docker-composeファイルの構成